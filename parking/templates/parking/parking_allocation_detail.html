{% extends 'base.html' %}

{% block title %}Parking Allocation Details{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>Parking Allocation Details</h1>
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Event: {{ allocation.event.name }}</h5>
            <p class="card-text">Date: {{ allocation.event.match_date|date:"F j, Y, g:i a" }}</p>
            <p class="card-text">Parking Zone: {{ allocation.space.zone.name }}</p>
            <p class="card-text">Parking Space: {{ allocation.space.space_number }}</p>
            <hr>
            <h5>Your QR Code:</h5>
            <img src="data:image/png;base64,{{ allocation.qr_code }}" alt="Parking QR Code">
            <hr>
            <h5>Location:</h5>
            <div id="map" style="height: 400px;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let map;
    let markers = [];

    function initMap() {
        const allocatedLat = parseFloat("{{ allocation.space.gps_coordinates.split|first }}");
        const allocatedLng = parseFloat("{{ allocation.space.gps_coordinates.split|last }}");

        const allocatedLocation = { lat: allocatedLat, lng: allocatedLng };

        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 15,
            center: allocatedLocation,
        });

        // Add marker for the allocated space
        new google.maps.Marker({
            position: allocatedLocation,
            map: map,
            title: 'Your Parking Space',
            icon: {
                url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
            } // Highlighted icon
        });

        // Fetch all parking data and add markers
        fetch('/parking/api/parking-data/')
            .then(response => response.json())
            .then(data => {
                data.spaces.forEach(space => {
                    if (space.gps_coordinates) {
                        const [lat, lng] = space.gps_coordinates.split(',').map(Number);
                        const location = { lat: lat, lng: lng };
                        
                        // Only add marker if it's not the allocated space (to avoid duplicate markers)
                        if (!(lat === allocatedLat && lng === allocatedLng)) {
                            new google.maps.Marker({
                                position: location,
                                map: map,
                                title: `${space.zone_name} - ${space.space_number} (${space.is_available ? 'Available' : 'Occupied'})`,
                                icon: {
                                    url: space.is_available ? "http://maps.google.com/mapfiles/ms/icons/green-dot.png" : "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                                }
                            });
                        }
                    }
                });
            })
            .catch(error => console.error('Error fetching parking data:', error));
    }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"></script>
{% endblock %}
