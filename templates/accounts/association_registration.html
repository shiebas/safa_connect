{% extends 'base.html' %}

{% block title %}Referee Association Administrator Registration{% endblock %}

{% block extra_css %}
<style>
    .form-control-file {
        padding: 0.375rem 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
    }
    .registration-form {
        max-width: 800px;
        margin: 0 auto;
    }
    .form-section {
        border-bottom: 1px solid #eee;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
    }
    .form-section-title {
        color: #495057;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="card registration-form">
        <div class="card-header text-center">
            <h2>Referee Association Administrator Registration</h2>
            <p class="text-muted mb-0">Register to manage referees for your association</p>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" novalidate>
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    <ul class="mb-0">
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Personal Information -->
                <div class="form-section">
                    <h4 class="form-section-title">Personal Information</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.first_name.id_for_label }}">First Name</label>
                                {{ form.first_name }}
                                {% if form.first_name.errors %}
                                <div class="text-danger">{{ form.first_name.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.last_name.id_for_label }}">Last Name</label>
                                {{ form.last_name }}
                                {% if form.last_name.errors %}
                                <div class="text-danger">{{ form.last_name.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.email.id_for_label }}">Email Address</label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                <div class="text-danger">{{ form.email.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.date_of_birth.id_for_label }}">Date of Birth</label>
                                {{ form.date_of_birth }}
                                {% if form.date_of_birth.errors %}
                                <div class="text-danger">{{ form.date_of_birth.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Information -->
                <div class="form-section">
                    <h4 class="form-section-title">Identification</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.id_document_type.id_for_label }}">ID Document Type</label>
                                {{ form.id_document_type }}
                                {% if form.id_document_type.errors %}
                                <div class="text-danger">{{ form.id_document_type.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.id_number.id_for_label }}">ID Number</label>
                                {{ form.id_number }}
                                {% if form.id_number.errors %}
                                <div class="text-danger">{{ form.id_number.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group mb-3">
                                <label for="{{ form.id_document.id_for_label }}">Upload ID Document</label>
                                {{ form.id_document }}
                                {% if form.id_document.errors %}
                                <div class="text-danger">{{ form.id_document.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Upload a scanned copy or photo of your ID document.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Association Information -->
                <div class="form-section">
                    <h4 class="form-section-title">Association Information</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.province.id_for_label }}">Province</label>
                                {{ form.province }}
                                {% if form.province.errors %}
                                <div class="text-danger">{{ form.province.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.region.id_for_label }}">Region</label>
                                {{ form.region }}
                                {% if form.region.errors %}
                                <div class="text-danger">{{ form.region.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.local_federation.id_for_label }}">Local Football Association</label>
                                {{ form.local_federation }}
                                {% if form.local_federation.errors %}
                                <div class="text-danger">{{ form.local_federation.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.association.id_for_label }}">Referee Association</label>
                                {{ form.association }}
                                {% if form.association.errors %}
                                <div class="text-danger">{{ form.association.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Select the referee association you represent.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Password Section -->
                <div class="form-section">
                    <h4 class="form-section-title">Account Security</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.password1.id_for_label }}">Password</label>
                                {{ form.password1 }}
                                {% if form.password1.errors %}
                                <div class="text-danger">{{ form.password1.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.password2.id_for_label }}">Confirm Password</label>
                                {{ form.password2 }}
                                {% if form.password2.errors %}
                                <div class="text-danger">{{ form.password2.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- POPI Act Consent -->
                <div class="form-section">
                    <h4 class="form-section-title">Privacy Consent</h4>
                    <div class="form-group mb-3">
                        <div class="form-check">
                            {{ form.popi_act_consent }}
                            <label class="form-check-label" for="{{ form.popi_act_consent.id_for_label }}">
                                I consent to the collection and processing of my personal information in accordance with POPI Act
                            </label>
                            {% if form.popi_act_consent.errors %}
                            <div class="text-danger">{{ form.popi_act_consent.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">Register as Association Administrator</button>
                </div>
            </form>
        </div>
        <div class="card-footer text-center">
            <p class="mb-0">Already have an account? <a href="{% url 'accounts:login' %}">Login here</a></p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Province, Region, LFA dynamic dropdowns
        const provinceSelect = document.getElementById('id_province');
        const regionSelect = document.getElementById('id_region');
        const lfaSelect = document.getElementById('id_local_federation');
        const associationSelect = document.getElementById('id_association');

        // Disable selects initially
        regionSelect.disabled = true;
        lfaSelect.disabled = true;
        associationSelect.disabled = true;

        // When province changes, update regions
        provinceSelect.addEventListener('change', function() {
            const provinceId = provinceSelect.value;
            regionSelect.innerHTML = '<option value="">Select a region</option>';
            regionSelect.disabled = !provinceId;
            lfaSelect.innerHTML = '<option value="">Select an LFA</option>';
            lfaSelect.disabled = true;
            associationSelect.innerHTML = '<option value="">Select an association</option>';
            associationSelect.disabled = true;

            if (provinceId) {
                fetch(`/accounts/api/regions/?province=${provinceId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(region => {
                            const option = document.createElement('option');
                            option.value = region.id;
                            option.textContent = region.name;
                            regionSelect.appendChild(option);
                        });
                    });
            }
        });

        // When region changes, update LFAs
        regionSelect.addEventListener('change', function() {
            const regionId = regionSelect.value;
            lfaSelect.innerHTML = '<option value="">Select an LFA</option>';
            lfaSelect.disabled = !regionId;
            associationSelect.innerHTML = '<option value="">Select an association</option>';
            associationSelect.disabled = true;

            if (regionId) {
                fetch(`/accounts/api/lfas/?region=${regionId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(lfa => {
                            const option = document.createElement('option');
                            option.value = lfa.id;
                            option.textContent = lfa.name;
                            lfaSelect.appendChild(option);
                        });
                    });
            }
        });

        // When LFA changes, update associations
        lfaSelect.addEventListener('change', function() {
            const lfaId = lfaSelect.value;
            associationSelect.innerHTML = '<option value="">Select an association</option>';
            associationSelect.disabled = !lfaId;

            if (lfaId) {
                // Assuming there's an API to get associations by LFA
                fetch(`/geography/api/associations/?lfa=${lfaId}&type=referee`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(association => {
                            const option = document.createElement('option');
                            option.value = association.id;
                            option.textContent = association.name;
                            associationSelect.appendChild(option);
                        });
                    });
            }
        });

        // ID Document Type field handling
        const idDocTypeSelect = document.getElementById('id_id_document_type');
        const idNumberField = document.getElementById('id_id_number');

        idDocTypeSelect.addEventListener('change', function() {
            const selectedType = idDocTypeSelect.value;
            
            // Update label and placeholder based on document type
            if (selectedType === 'PP') {
                idNumberField.placeholder = 'Enter passport number';
                idNumberField.labels[0].textContent = 'Passport Number';
            } else if (selectedType === 'ID') {
                idNumberField.placeholder = 'Enter ID number (13 digits)';
                idNumberField.labels[0].textContent = 'ID Number';
            } else if (selectedType === 'DL') {
                idNumberField.placeholder = 'Enter driver license number';
                idNumberField.labels[0].textContent = 'Driver License Number';
            } else {
                idNumberField.placeholder = 'Enter document number';
                idNumberField.labels[0].textContent = 'Document Number';
            }
        });
    });
</script>
{% endblock %}
