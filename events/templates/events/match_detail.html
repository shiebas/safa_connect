{% extends 'base.html' %}

{% block title %}Match Details - {{ match.name }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>{{ match.name }}</h1>
    <p class="lead">{{ match.stadium.name }} - {{ match.match_date|date:"F j, Y, g:i a" }}</p>

    {% if is_early_bird %}
        <div class="alert alert-info">Early bird discount is active!</div>
    {% endif %}

    <form method="post" id="bookingForm">
        {% csrf_token %}
        {% for tier, seats_data in seats_by_tier.items %}
            <h2>{{ tier }}</h2>
            <div class="row">
                {% for data in seats_data %}
                    <div class="col-md-3 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Seat {{ data.seat.section }}{{ data.seat.row }}-{{ data.seat.seat_number }}</h5>
                                <p class="card-text">Price: R{{ data.final_price|floatformat:2 }}</p>
                                <button type="button" class="btn btn-primary book-ticket-btn" data-seat-id="{{ data.seat.id }}" data-tier="{{ tier }}">Book Now</button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const bookingForm = document.getElementById('bookingForm');
    const bookTicketButtons = document.querySelectorAll('.book-ticket-btn');

    bookTicketButtons.forEach(button => {
        button.addEventListener('click', function() {
            const seatId = this.dataset.seatId;
            const tier = this.dataset.tier;

            // In a real application, you would have a more sophisticated booking process.
            // For now, we'll just simulate a booking and then allocate parking if it's a VIP ticket.
            alert(`Booking seat ${seatId}...`);

            if (tier === 'VIP') {
                fetch(`/parking/allocate/{{ match.id }}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Parking space allocated successfully! Your QR code will be sent to you.');
                    } else {
                        alert(`Error allocating parking: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error allocating parking:', error);
                    alert('An error occurred while allocating parking.');
                });
            }
        });
    });
});
</script>
{% endblock %}
