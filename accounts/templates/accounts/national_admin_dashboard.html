{% extends "admin/base_admin_dashboard.html" %}
{% load static %}
{% csrf_token %}

{% block title %}National Admin Dashboard - UPDATED{% endblock %}

{% block quick_actions %}
<div class="row g-3">
    <div class="col-md-4">
        <a href="{% url 'membership:invoice_list' %}" class="btn btn-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-file-invoice fa-2x mb-2"></i>
            <span>Manage Invoices</span>
        </a>
    </div>
    <div class="col-md-4">
        <a href="{% url 'accounts:national_admin_invoices' %}" class="btn btn-info w-100 h-100 d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-building fa-2x mb-2"></i>
            <span>Organization Invoices</span>
        </a>
    </div>
    <div class="col-md-4">
        <a href="{% url 'accounts:confirm_payment' %}" class="btn btn-success w-100 h-100 d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-check-circle fa-2x mb-2"></i>
            <span>Confirm Payment</span>
        </a>
    </div>
    <div class="col-md-4">
        <a href="{% url 'accounts:admin_add_referee' %}" class="btn btn-warning w-100 h-100 d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-user-tie fa-2x mb-2"></i>
            <span>Add Referee</span>
        </a>
    </div>
    <div class="col-md-4">
        <a href="{% url 'membership:add_season_config' %}" class="btn btn-secondary w-100 h-100 d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-calendar-plus fa-2x mb-2"></i>
            <span>Add Season</span>
        </a>
    </div>
    <div class="col-md-4">
        <a href="{% url 'admin:membership_safafeestructure_changelist' %}" class="btn btn-dark w-100 h-100 d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-coins fa-2x mb-2"></i>
            <span>SAFA Fees</span>
        </a>
    </div>
    <div class="col-md-4">
        <a href="{% url 'accounts:province_compliance_view' %}" class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-shield-alt fa-2x mb-2"></i>
            <span>Province Compliance</span>
        </a>
    </div>
    <div class="col-md-4">
        <a href="{% url 'accounts:member_cards_admin' %}" class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-id-card fa-2x mb-2"></i>
            <span>Print Membership Cards</span>
        </a>
    </div>
    <div class="col-md-4">
        <a href="{% url 'accounts:member_approvals_list' %}" class="btn btn-outline-warning w-100 h-100 d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-user-check fa-2x mb-2"></i>
            <span>Member Approvals</span>
        </a>
    </div>
</div>
{% endblock %}

{% block dashboard_content %}
<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="stats-card">
            <div class="stats-number">R {{ total_paid|floatformat:0|default:"0" }}</div>
            <div class="stats-label">Total Paid</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stats-card">
            <div class="stats-number">R {{ total_outstanding|floatformat:0|default:"0" }}</div>
            <div class="stats-label">Total Outstanding</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stats-card">
            <div class="stats-number">{{ pending_provinces.count|add:pending_regions.count|add:pending_lfas.count|add:pending_associations.count|add:pending_clubs.count|default:"0" }}</div>
            <div class="stats-label">Pending Approvals</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stats-card">
            <div class="stats-number">9</div>
            <div class="stats-label">Quick Actions</div>
        </div>
    </div>
</div>

<!-- Pending Organization Approvals -->
<div class="content-card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-clock me-2 text-warning"></i>
            Pending Organization Approvals
            <span class="badge bg-warning text-dark ms-2">{{ pending_organizations.paginator.count }}</span>
        </h5>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#pendingFilters" aria-expanded="false">
                <i class="fas fa-filter me-1"></i>Filters
            </button>
        </div>
    </div>
    
    <!-- Filters Collapse -->
    <div class="collapse" id="pendingFilters">
        <div class="card-body border-bottom">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small text-muted">Organization Type</label>
                    <select class="form-select form-select-sm" id="orgTypeFilter">
                        <option value="">All Types</option>
                        <option value="province">Provinces Only</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">Sort By</label>
                    <select class="form-select form-select-sm" id="sortFilter">
                        <option value="name">Name (A-Z)</option>
                        <option value="type">Type</option>
                        <option value="date">Date Added</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-body">
        {% if pending_organizations %}
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40px;">
                            <i class="fas fa-building text-primary"></i>
                        </th>
                        <th>Organization Details</th>
                        <th>Type & Location</th>
                        <th>Status</th>
                        <th class="text-center" style="width: 200px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for org in pending_organizations %}
                    <tr class="org-row" data-type="{{ org.get_model_name|lower }}">
                        <td>
                            <div class="org-icon">
                                {% if org.get_model_name == 'Province' %}
                                    <i class="fas fa-map text-primary fa-lg"></i>
                                {% elif org.get_model_name == 'Region' %}
                                    <i class="fas fa-map-marker-alt text-info fa-lg"></i>
                                {% elif org.get_model_name == 'LocalFootballAssociation' %}
                                    <i class="fas fa-building text-success fa-lg"></i>
                                {% elif org.get_model_name == 'Association' %}
                                    <i class="fas fa-handshake text-warning fa-lg"></i>
                                {% elif org.get_model_name == 'Club' %}
                                    <i class="fas fa-futbol text-danger fa-lg"></i>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <strong class="text-dark">{{ org.name }}</strong>
                                {% if org.code %}
                                    <small class="text-muted">Code: {{ org.code }}</small>
                                {% endif %}
                                {% if org.description %}
                                    <small class="text-muted">{{ org.description|truncatechars:60 }}</small>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="badge bg-secondary mb-1">{{ org.get_model_name }}</span>
                                {% if org.province %}
                                    <small class="text-muted">Province: {{ org.province.name }}</small>
                                {% elif org.region %}
                                    <small class="text-muted">Region: {{ org.region.name }}</small>
                                {% elif org.local_federation %}
                                    <small class="text-muted">LFA: {{ org.local_federation.name }}</small>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="badge status-badge status-{{ org.status|lower }}">
                                {{ org.get_status_display }}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="d-flex flex-column align-items-center">
                                <span class="badge bg-info text-dark mb-2">
                                    {% if org.is_compliant %}
                                        <i class="fas fa-check-circle me-1"></i>Compliant
                                    {% else %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>Non-Compliant
                                    {% endif %}
                                </span>
                                {% if org.get_model_name == 'Province' %}
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="approveOrganization('province', {{ org.id }})">
                                        <i class="fas fa-check me-1"></i>Approve Province
                                    </button>
                                {% else %}
                                    <span class="badge bg-secondary text-white">
                                        <i class="fas fa-info-circle me-1"></i>View Only
                                    </span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if pending_organizations.paginator.num_pages > 1 %}
        <nav aria-label="Pending organizations pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if pending_organizations.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?pending_page=1" aria-label="First">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?pending_page={{ pending_organizations.previous_page_number }}">
                            <i class="fas fa-angle-left"></i> Previous
                        </a>
                    </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">
                        Page {{ pending_organizations.number }} of {{ pending_organizations.paginator.num_pages }}
                    </span>
                </li>
                
                {% if pending_organizations.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?pending_page={{ pending_organizations.next_page_number }}">
                            Next <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?pending_page={{ pending_organizations.paginator.num_pages }}" aria-label="Last">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
            <h6 class="text-muted">No organizations are currently waiting for approval</h6>
            <p class="text-muted small">All organizations have been processed and approved.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- All Provinces Overview -->
<div class="content-card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-map me-2 text-primary"></i>
            All Provinces Overview
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Province Name</th>
                        <th>Status</th>
                        <th>Compliance</th>
                        <th>Regions</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for province in all_provinces %}
                    <tr>
                        <td>
                            <div class="d-flex flex-column">
                                <strong class="text-dark">{{ province.name }}</strong>
                                {% if province.code %}
                                    <small class="text-muted">Code: {{ province.code }}</small>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="badge status-badge status-{{ province.status|lower }}">
                                {{ province.get_status_display }}
                            </span>
                        </td>
                        <td>
                            {% if province.is_compliant %}
                                <span class="badge bg-success text-white">
                                    <i class="fas fa-check-circle me-1"></i>Compliant
                                </span>
                            {% else %}
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Non-Compliant
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-info text-white">
                                {{ province.region_set.count }} Regions
                            </span>
                        </td>
                        <td class="text-center">
                            {% if province.status == 'INACTIVE' and province.is_compliant %}
                                <button type="button" class="btn btn-success btn-sm" onclick="approveOrganization('province', {{ province.id }})">
                                    <i class="fas fa-check me-1"></i>Approve
                                </button>
                            {% elif province.status == 'ACTIVE' %}
                                <span class="badge bg-success text-white">
                                    <i class="fas fa-check me-1"></i>Active
                                </span>
                            {% else %}
                                <span class="badge bg-secondary text-white">
                                    <i class="fas fa-info-circle me-1"></i>View Only
                                </span>
                            {% endif %}
                            <br>
                            <small class="text-muted">
                                <a href="{% url 'accounts:province_compliance_view' %}" class="text-decoration-none">
                                    <i class="fas fa-edit me-1"></i>Update Compliance
                                </a>
                            </small>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">No provinces found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- All Members -->
<div class="content-card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-users me-2 text-primary"></i>
            All Members
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Age</th>
                        <th>Organization</th>
                        <th>Status</th>
                        <th>Gender</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for member in members %}
                    <tr>
                        <td>{{ member.user.get_full_name }}</td>
                        <td>{{ member.user.email }}</td>
                        <td>{{ member.age }}</td>
                        <td>{{ member.current_club.name|default:"N/A" }}</td>
                        <td>
                            <span class="badge status-badge status-{{ member.membership_status|lower }}">
                                {{ member.get_membership_status_display }}
                            </span>
                        </td>
                        <td>{{ member.gender }}</td>
                        <td class="text-center">
                            <span class="badge bg-secondary text-white">
                                <i class="fas fa-eye me-1"></i>View Only
                            </span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">No members found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Organization type filter
    const orgTypeFilter = document.getElementById('orgTypeFilter');
    const orgRows = document.querySelectorAll('.org-row');
    
    if (orgTypeFilter) {
        orgTypeFilter.addEventListener('change', function() {
            const selectedType = this.value;
            
            orgRows.forEach(row => {
                const orgType = row.getAttribute('data-type');
                if (selectedType === '' || orgType === selectedType) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
    
    // Sort functionality
    const sortFilter = document.getElementById('sortFilter');
    if (sortFilter) {
        sortFilter.addEventListener('change', function() {
            const sortBy = this.value;
            const tbody = document.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                if (sortBy === 'name') {
                    const nameA = a.querySelector('strong').textContent.toLowerCase();
                    const nameB = b.querySelector('strong').textContent.toLowerCase();
                    return nameA.localeCompare(nameB);
                } else if (sortBy === 'type') {
                    const typeA = a.getAttribute('data-type');
                    const typeB = b.getAttribute('data-type');
                    return typeA.localeCompare(typeB);
                }
                return 0;
            });
            
            rows.forEach(row => tbody.appendChild(row));
        });
    }
});

// Approve province function (National Admin can only approve provinces)
function approveOrganization(orgType, orgId) {
    if (orgType !== 'province') {
        alert('National Admin can only approve provinces.');
        return;
    }
    
    if (confirm('Are you sure you want to approve this province? This will generate an invoice for the province.')) {
        // Create a form to submit the approval
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "accounts:update_organization_status" %}';
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        // Add organization type and ID
        const orgTypeInput = document.createElement('input');
        orgTypeInput.type = 'hidden';
        orgTypeInput.name = 'org_type';
        orgTypeInput.value = orgType;
        form.appendChild(orgTypeInput);
        
        const orgIdInput = document.createElement('input');
        orgIdInput.type = 'hidden';
        orgIdInput.name = 'org_id';
        orgIdInput.value = orgId;
        form.appendChild(orgIdInput);
        
        // Add new status
        const statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'new_status';
        statusInput.value = 'ACTIVE';
        form.appendChild(statusInput);
        
        // Submit the form
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
