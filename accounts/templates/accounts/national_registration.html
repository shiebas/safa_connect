{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}SAFA System Administrator Registration{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/safa_style.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="registration-form">
                <div class="form-header text-center">
                    <i class="fas fa-flag fa-3x mb-3"></i>
                    <h2 class="mb-0">SAFA System Administrator Registration</h2>
                </div>
                <!-- Removed static progress indicator, only JS wizard will show steps -->
                <div class="p-4">
                    <form action="{% url 'accounts:national_registration' %}" method="post" enctype="multipart/form-data">
                        {% crispy form %}
                        
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-submit btn-lg text-white">
                                <i class="fas fa-user-plus me-2"></i>Register as SAFA System Administrator
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{% static 'js/sa_id_validation.js' %}"></script>
<script>
    const getRegionsUrl = "{% url 'accounts:get_regions_for_province' %}";
    const getLfasUrl = "{% url 'accounts:get_lfas_for_region' %}";
    const getClubsUrl = "{% url 'accounts:get_clubs_for_lfa' %}";
    const checkIdNumberUrl = "{% url 'accounts:check_id_number' %}";

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2
    $('#id_club').select2({
        placeholder: "Select a club",
        allowClear: true
    });

    // Get all necessary elements once
    const docTypeSelect = document.getElementById('id_id_document_type');
    const saIdContainer = document.getElementById('div_id_id_number');
    const passportContainer = document.getElementById('div_id_passport_number');
    const dobGenderManualRow = document.getElementById('dob-gender-manual-row');
    const idNumberInput = document.getElementById('id_id_number');
    const firstNameInput = document.getElementById('id_first_name');
    const lastNameInput = document.getElementById('id_last_name');
    const phoneNumberInput = document.getElementById('id_phone_number');


    // Organization elements
    const orgTypeSelect = document.getElementById('id_organization_type');
    const provinceField = document.getElementById('div_id_province');
    const regionField = document.getElementById('div_id_region');
    const lfaField = document.getElementById('div_id_local_federation');
    const clubField = document.getElementById('div_id_club');
    const provinceSelect = document.getElementById('id_province');
    const regionSelect = document.getElementById('id_region');
    const lfaSelect = document.getElementById('id_local_federation');

    // Create validation message elements
    function createValidationMessageElement(field) {
        let msgElement = document.getElementById(field.id + '_validation_message');
        if (!msgElement) {
            msgElement = document.createElement('div');
            msgElement.id = field.id + '_validation_message';
            msgElement.className = 'form-text small';
            field.parentNode.appendChild(msgElement);
        }
        return msgElement;
    }

    const idValidationMessage = createValidationMessageElement(idNumberInput);
    const firstNameValidationMessage = createValidationMessageElement(firstNameInput);
    const lastNameValidationMessage = createValidationMessageElement(lastNameInput);
    const phoneNumberValidationMessage = createValidationMessageElement(phoneNumberInput);


    // Document type toggle function
    function toggleFields() {
        if (!docTypeSelect) return;

        const selectedValue = docTypeSelect.value;

        if(saIdContainer) saIdContainer.style.display = 'none';
        if(passportContainer) passportContainer.style.display = 'none';
        if(dobGenderManualRow) dobGenderManualRow.style.display = 'none';

        if (selectedValue === 'ID' || selectedValue === 'BC') {
            if(saIdContainer) saIdContainer.style.display = 'block';
        } else if (selectedValue === 'PP' || selectedValue === 'DL' || selectedValue === 'OT') {
            if(passportContainer) passportContainer.style.display = 'block';
            if(dobGenderManualRow) dobGenderManualRow.style.display = 'flex';
        }
    }

    // Organization fields toggle function
    function updateOrgFields() {
        if (!orgTypeSelect) return;

        const selectedOption = orgTypeSelect.options[orgTypeSelect.selectedIndex];
        const optionText = selectedOption ? selectedOption.text.toUpperCase() : '';

        if (provinceField) provinceField.style.display = 'none';
        if (regionField) {
            regionField.style.display = 'none';
            regionSelect.innerHTML = '<option value="">---------</option>';
        }
        if (lfaField) {
            lfaField.style.display = 'none';
            lfaSelect.innerHTML = '<option value="">---------</option>';
        }
        if (clubField) {
            clubField.style.display = 'none';
            $('#id_club').empty().append('<option value="">---------</option>').trigger('change');
        }

        if (optionText.includes('PROVINCE')) {
            if (provinceField) provinceField.style.display = 'block';
        } else if (optionText.includes('REGION')) {
            if (provinceField) provinceField.style.display = 'block';
            if (regionField) regionField.style.display = 'block';
        } else if (optionText.includes('LFA') || optionText.includes('LOCAL')) {
            if (provinceField) provinceField.style.display = 'block';
            if (regionField) regionField.style.display = 'block';
            if (lfaField) lfaField.style.display = 'block';
        } else if (optionText.includes('CLUB')) {
            if (provinceField) provinceField.style.display = 'block';
            if (regionField) regionField.style.display = 'block';
            if (lfaField) lfaField.style.display = 'block';
            if (clubField) clubField.style.display = 'block';
        }
    }

    // Province change handler
    function handleProvinceChange() {
        if (!provinceSelect || !regionSelect || !lfaSelect) return;

        const provinceId = provinceSelect.value;

        regionSelect.innerHTML = '<option value="">Loading regions...</option>';
        regionSelect.disabled = true;
        lfaSelect.innerHTML = '<option value="">---------</option>';
        lfaSelect.disabled = true;
        $('#id_club').empty().append('<option value="">---------</option>').trigger('change');

        if (provinceId) {
            fetch(`${getRegionsUrl}?province_id=${provinceId}`)
                .then(response => response.json())
                .then(data => {
                    regionSelect.innerHTML = '<option value="">Select a region</option>';
                    if (Array.isArray(data)) {
                        data.forEach(region => {
                            const option = document.createElement('option');
                            option.value = region.id;
                            option.textContent = region.name;
                            regionSelect.appendChild(option);
                        });
                    }
                    regionSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Error fetching regions:', error);
                    regionSelect.innerHTML = '<option value="">Error loading regions</option>';
                });
        } else {
            regionSelect.innerHTML = '<option value="">---------</option>';
            regionSelect.disabled = false;
        }
    }

    // Region change handler
    function handleRegionChange() {
        if (!regionSelect || !lfaSelect) return;

        const regionId = regionSelect.value;

        lfaSelect.innerHTML = '<option value="">Loading LFAs...</option>';
        lfaSelect.disabled = true;
        $('#id_club').empty().append('<option value="">---------</option>').trigger('change');

        if (regionId) {
            fetch(`${getLfasUrl}?region_id=${regionId}`)
                .then(response => response.json())
                .then(data => {
                    lfaSelect.innerHTML = '<option value="">Select an LFA</option>';
                    if (Array.isArray(data)) {
                        data.forEach(lfa => {
                            const option = document.createElement('option');
                            option.value = lfa.id;
                            option.textContent = lfa.name;
                            lfaSelect.appendChild(option);
                        });
                    }
                    lfaSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Error fetching LFAs:', error);
                    lfaSelect.innerHTML = '<option value="">Error loading LFAs</option>';
                });
        } else {
            lfaSelect.innerHTML = '<option value="">---------</option>';
            lfaSelect.disabled = false;
        }
    }

    // LFA change handler for clubs
    function handleLFAChange() {
        const clubSelect = $('#id_club');
        if (!lfaSelect || !clubSelect.length) return;

        const lfaId = lfaSelect.value;

        clubSelect.empty().append('<option value="">Loading clubs...</option>').trigger('change');
        clubSelect.prop('disabled', true);

        if (lfaId) {
            fetch(`${getClubsUrl}?lfa_id=${lfaId}`)
                .then(response => response.json())
                .then(data => {
                    clubSelect.empty().append('<option value="">Select a club</option>').trigger('change');
                    if (Array.isArray(data)) {
                        data.forEach(club => {
                            const option = new Option(club.name, club.id, false, false);
                            clubSelect.append(option);
                        });
                    }
                    clubSelect.prop('disabled', false).trigger('change');
                })
                .catch(error => {
                    console.error('Error fetching clubs:', error);
                    clubSelect.empty().append('<option value="">Error loading clubs</option>').trigger('change');
                });
        } else {
            clubSelect.empty().append('<option value="">---------</option>').trigger('change');
            clubSelect.prop('disabled', false);
        }
    }
    
    // Event listeners
    if (docTypeSelect) {
        docTypeSelect.addEventListener('change', toggleFields);
    }
    
    if (idNumberInput) {
        idNumberInput.addEventListener('input', function() {
            if (docTypeSelect && (docTypeSelect.value === 'ID' || docTypeSelect.value === 'BC')) {
                if (typeof validateSAIDNumber === 'function') {
                    const result = validateSAIDNumber(this.value);
                    idValidationMessage.textContent = result.errorMessage || `Valid ID. DOB: ${result.dateOfBirth}, Gender: ${result.gender}`;
                    idValidationMessage.className = result.isValid ? "form-text text-success small" : "form-text text-danger small";

                    if (result.isValid) {
                        // Check for uniqueness
                        fetch(`${checkIdNumberUrl}?id_number=${this.value}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.exists) {
                                    idValidationMessage.textContent = "This ID number is already registered.";
                                    idValidationMessage.className = "form-text text-danger small";
                                }
                            });
                    }
                }
            }
        });
    }

    function validateName(field, messageElement) {
        const value = field.value;
        if (value.length > 0 && value.length < 3) {
            messageElement.textContent = "Must be at least 3 characters.";
            messageElement.className = "form-text text-danger small";
        } else if (/\d/.test(value)) {
            messageElement.textContent = "Name cannot contain numbers.";
            messageElement.className = "form-text text-danger small";
        } else {
            messageElement.textContent = "";
        }
    }

    function validatePhoneNumber(field, messageElement) {
        const value = field.value;
        const pattern = /^\+?[0-9]+$/;
        if (value && !pattern.test(value)) {
            messageElement.textContent = "Must be numeric, optionally starting with a '+'";
            messageElement.className = "form-text text-danger small";
        } else {
            messageElement.textContent = "";
        }
    }

    if (firstNameInput) {
        firstNameInput.addEventListener('input', () => validateName(firstNameInput, firstNameValidationMessage));
    }
    if (lastNameInput) {
        lastNameInput.addEventListener('input', () => validateName(lastNameInput, lastNameValidationMessage));
    }
    if (phoneNumberInput) {
        phoneNumberInput.addEventListener('input', () => validatePhoneNumber(phoneNumberInput, phoneNumberValidationMessage));
    }
    
    if (orgTypeSelect) {
        orgTypeSelect.addEventListener('change', updateOrgFields);
    }
    
    if (provinceSelect) {
        provinceSelect.addEventListener('change', handleProvinceChange);
    }
    if (regionSelect) {
        regionSelect.addEventListener('change', handleRegionChange);
    }
    if (lfaSelect) {
        lfaSelect.addEventListener('change', handleLFAChange);
    }

    // Initial setup
    toggleFields();
    updateOrgFields();
});
</script>
{% endblock %}