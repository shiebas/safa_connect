<!-- accounts/member_approvals.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Member Approvals - {{ jurisdiction }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="text-safa-green mb-1">Member Approvals</h2>
            <p class="text-muted">{{ jurisdiction }} â€¢ {{ total_pending }} pending approval</p>
        </div>
        <div class="col-md-4 text-md-end">
            <div class="btn-group" role="group">
                <a href="?status=pending" class="btn {% if status_filter == 'pending' %}btn-safa-primary{% else %}btn-outline-secondary{% endif %}">
                    Pending ({{ total_pending }})
                </a>
                <a href="?status=approved" class="btn {% if status_filter == 'approved' %}btn-safa-primary{% else %}btn-outline-secondary{% endif %}">
                    Approved
                </a>
                <a href="?status=all" class="btn {% if status_filter == 'all' %}btn-safa-primary{% else %}btn-outline-secondary{% endif %}">
                    All Members
                </a>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-md-4">
            <select class="form-select" id="roleFilter" onchange="filterByRole(this.value)">
                <option value="">All Roles</option>
                {% for role_code, role_name in available_roles %}
                <option value="{{ role_code }}" {% if role_filter == role_code %}selected{% endif %}>
                    {{ role_name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <input type="text" class="form-control" placeholder="Search members..." id="searchInput">
        </div>
        <div class="col-md-4">
            <button class="btn btn-safa-secondary" onclick="exportMembers()">
                <i class="fas fa-download me-2"></i>Export List
            </button>
        </div>
    </div>

    <!-- Members Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            {% if members %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th><input type="checkbox" id="selectAll" class="form-check-input"></th>
                            <th>Member</th>
                            <th>Role</th>
                            <th>Organization</th>
                            <th>Registration Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in members %}
                        <tr>
                            <td>
                                <input type="checkbox" class="form-check-input member-checkbox" 
                                       value="{{ member.id }}">
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle me-3">
                                        {% if member.profile_photo %}
                                        <img src="{{ member.profile_photo.url }}" alt="{{ member.get_full_name }}" 
                                             class="rounded-circle" width="40" height="40">
                                        {% else %}
                                        <div class="bg-safa-green text-white rounded-circle d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            {{ member.first_name.0 }}{{ member.last_name.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <div class="fw-semibold">{{ member.get_full_name }}</div>
                                        <small class="text-muted">{{ member.email }}</small>
                                        {% if member.safa_id %}
                                        <div><small class="badge bg-secondary">{{ member.safa_id }}</small></div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ member.get_role_display }}</span>
                            </td>
                            <td>
                                {% if member.club %}
                                    <div class="fw-semibold">{{ member.club.name }}</div>
                                    <small class="text-muted">Club</small>
                                {% elif member.association %}
                                    <div class="fw-semibold">{{ member.association.name }}</div>
                                    <small class="text-muted">Association</small>
                                {% elif member.local_federation %}
                                    <div class="fw-semibold">{{ member.local_federation.name }}</div>
                                    <small class="text-muted">LFA</small>
                                {% elif member.region %}
                                    <div class="fw-semibold">{{ member.region.name }}</div>
                                    <small class="text-muted">Region</small>
                                {% elif member.province %}
                                    <div class="fw-semibold">{{ member.province.name }}</div>
                                    <small class="text-muted">Province</small>
                                {% else %}
                                    <span class="text-muted">Not assigned</span>
                                {% endif %}
                            </td>
                            <td>
                                <div>{{ member.date_joined|date:"M d, Y" }}</div>
                                <small class="text-muted">{{ member.date_joined|timesince }} ago</small>
                            </td>
                            <td>
                                {% if member.is_active %}
                                    <span class="badge bg-success">Approved</span>
                                {% else %}
                                    <span class="badge bg-warning">Pending</span>
                                {% endif %}
                                
                                {% if member.membership_status == 'SUSPENDED' %}
                                    <span class="badge bg-danger ms-1">Suspended</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'accounts:member_detail' member.id %}" 
                                       class="btn btn-outline-primary" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if not member.is_active and status_filter == 'pending' %}
                                    <button class="btn btn-outline-success" 
                                            onclick="approveMember({{ member.id }})" title="Approve">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" 
                                            onclick="rejectMember({{ member.id }})" title="Reject">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if members.has_other_pages %}
            <div class="d-flex justify-content-between align-items-center p-3 border-top">
                <div class="text-muted">
                    Showing {{ members.start_index }} to {{ members.end_index }} of {{ members.paginator.count }} members
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        {% if members.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ members.previous_page_number }}&status={{ status_filter }}&role={{ role_filter }}">Previous</a>
                        </li>
                        {% endif %}
                        
                        {% for num in members.paginator.page_range %}
                        {% if members.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > members.number|add:'-3' and num < members.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}&status={{ status_filter }}&role={{ role_filter }}">{{ num }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}
                        
                        {% if members.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ members.next_page_number }}&status={{ status_filter }}&role={{ role_filter }}">Next</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}

            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No members found</h5>
                <p class="text-muted">There are no members matching your current filters.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Bulk Actions -->
    {% if members %}
    <div class="row mt-3">
        <div class="col-md-6">
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted">With selected:</span>
                <button class="btn btn-sm btn-success" onclick="bulkApprove()" disabled id="bulkApproveBtn">
                    <i class="fas fa-check me-1"></i>Approve
                </button>
                <button class="btn btn-sm btn-warning" onclick="bulkSuspend()" disabled id="bulkSuspendBtn">
                    <i class="fas fa-pause me-1"></i>Suspend
                </button>
                <button class="btn btn-sm btn-secondary" onclick="bulkExport()" disabled id="bulkExportBtn">
                    <i class="fas fa-download me-1"></i>Export
                </button>
            </div>
        </div>
        <div class="col-md-6 text-md-end">
            <span class="text-muted" id="selectedCount">0 selected</span>
        </div>
    </div>
    {% endif %}
</div>

<!-- Approval Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Approve Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to approve this member? This will:</p>
                <ul>
                    <li>Activate their account</li>
                    <li>Generate their SAFA ID (if not already assigned)</li>
                    <li>Send them an approval email</li>
                    <li>Enable access to all SAFA services</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmApprove">Approve Member</button>
            </div>
        </div>
    </div>
</div>

<!-- Rejection Modal -->
<div class="modal fade" id="rejectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Member Application</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="rejectionReason" class="form-label">Reason for rejection:</label>
                    <textarea class="form-control" id="rejectionReason" rows="3" 
                              placeholder="Please provide a reason for rejecting this application..."></textarea>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action will permanently delete the member's application and send them a rejection email.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmReject">Reject Application</button>
            </div>
        </div>
    </div>
</div>

<script>
let selectedMemberForAction = null;

// Select All functionality
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.member-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateBulkActionButtons();
});

// Individual checkbox change
document.querySelectorAll('.member-checkbox').forEach(cb => {
    cb.addEventListener('change', updateBulkActionButtons);
});

function updateBulkActionButtons() {
    const selected = document.querySelectorAll('.member-checkbox:checked');
    const count = selected.length;
    
    document.getElementById('selectedCount').textContent = `${count} selected`;
    
    const bulkButtons = ['bulkApproveBtn', 'bulkSuspendBtn', 'bulkExportBtn'];
    bulkButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
            btn.disabled = count === 0;
        }
    });
}

function approveMember(memberId) {
    selectedMemberForAction = memberId;
    const modal = new bootstrap.Modal(document.getElementById('approvalModal'));
    modal.show();
}

function rejectMember(memberId) {
    selectedMemberForAction = memberId;
    const modal = new bootstrap.Modal(document.getElementById('rejectionModal'));
    modal.show();
}

document.getElementById('confirmApprove').addEventListener('click', function() {
    if (selectedMemberForAction) {
        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/accounts/members/${selectedMemberForAction}/approve/`;
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            form.appendChild(csrfToken.cloneNode());
        }
        
        document.body.appendChild(form);
        form.submit();
    }
});

document.getElementById('confirmReject').addEventListener('click', function() {
    if (selectedMemberForAction) {
        const reason = document.getElementById('rejectionReason').value;
        
        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/accounts/members/${selectedMemberForAction}/reject/`;
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            form.appendChild(csrfToken.cloneNode());
        }
        
        const reasonInput = document.createElement('input');
        reasonInput.type = 'hidden';
        reasonInput.name = 'reason';
        reasonInput.value = reason;
        form.appendChild(reasonInput);
        
        document.body.appendChild(form);
        form.submit();
    }
});

function filterByRole(role) {
    const url = new URL(window.location);
    if (role) {
        url.searchParams.set('role', role);
    } else {
        url.searchParams.delete('role');
    }
    url.searchParams.delete('page'); // Reset pagination
    window.location.href = url.toString();
}

function bulkApprove() {
    const selected = getSelectedMembers();
    if (selected.length === 0) return;
    
    if (confirm(`Are you sure you want to approve ${selected.length} member(s)?`)) {
        submitBulkAction('approve', selected);
    }
}

function bulkSuspend() {
    const selected = getSelectedMembers();
    if (selected.length === 0) return;
    
    if (confirm(`Are you sure you want to suspend ${selected.length} member(s)?`)) {
        submitBulkAction('suspend', selected);
    }
}

function bulkExport() {
    const selected = getSelectedMembers();
    if (selected.length === 0) return;
    
    submitBulkAction('export', selected);
}

function getSelectedMembers() {
    const checkboxes = document.querySelectorAll('.member-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function submitBulkAction(action, memberIds) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "accounts:bulk_actions" %}';
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        form.appendChild(csrfToken.cloneNode());
    }
    
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = action;
    form.appendChild(actionInput);
    
    memberIds.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'selected_members';
        input.value = id;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}

function exportMembers() {
    window.location.href = '{% url "accounts:export_members" %}';
}

// Search functionality
let searchTimeout;
document.getElementById('searchInput').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const query = this.value.trim();
        const url = new URL(window.location);
        if (query) {
            url.searchParams.set('search', query);
        } else {
            url.searchParams.delete('search');
        }
        url.searchParams.delete('page'); // Reset pagination
        window.location.href = url.toString();
    }, 500);
});
</script>
{% endblock %}
