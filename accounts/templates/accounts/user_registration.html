{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}SAFA Member Registration{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <h1 class="mb-4 text-center">SAFA Member Registration</h1>

            <form method="post" enctype="multipart/form-data" id="registrationForm" novalidate>
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        {% for error in form.non_field_errors %}
                            <p class="mb-0">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                {% if form.errors and not form.non_field_errors %}
                     <div class="alert alert-danger" role="alert">
                        <p class="mb-0">Please correct the errors highlighted below to continue.</p>
                        {% for field in form %}
                            {% for error in field.errors %}
                                <p class="mb-0"><strong>{{ field.label }}:</strong> {{ error }}</p>
                            {% endfor %}
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="accordion" id="registrationAccordion">

                    <!-- Step 1: Role and Basic Info -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                Step 1: Your Role & Basic Information
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#registrationAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ form.role|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6 mb-3 d-flex align-items-center pt-3">
                                        {{ form.is_existing_member|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="mb-3 d-none" id="previous_safa_id_container">
                                    {{ form.previous_safa_id|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Personal Details -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                Step 2: Personal Details
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#registrationAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ form.first_name|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ form.last_name|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    {{ form.email|as_crispy_field }}
                                </div>
                                <div class="mb-3">
                                    {{ form.id_document_type|as_crispy_field }}
                                </div>
                                <div class="mb-3 d-none" id="sa_id_container">
                                    {{ form.id_number|as_crispy_field }}
                                </div>
                                <div class="mb-3 d-none" id="passport_container">
                                    {{ form.passport_number|as_crispy_field }}
                                </div>
                                <div class="row d-none" id="manual_dob_gender_container">
                                    <div class="col-md-6 mb-3">
                                        {{ form.date_of_birth|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ form.gender|as_crispy_field }}
                                    </div>
                                </div>
                                {{ form.extracted_dob }}
                                {{ form.extracted_gender }}
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Location -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingThree">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                Step 3: Your Location
                            </button>
                        </h2>
                        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#registrationAccordion">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <label for="id_province" class="form-label">Province</label>
                                    <select name="province" class="form-select" id="id_province">
                                        {% for choice in form.province.field.queryset %}
                                            <option value="{{ choice.pk }}" {% if form.province.value == choice.pk %}selected{% endif %}>{{ choice.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="id_region" class="form-label">Region</label>
                                    <select name="region" class="form-select" id="id_region">
                                        <option value="">Select Province First</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="id_lfa" class="form-label">Local Football Association</label>
                                    <select name="lfa" class="form-select" id="id_lfa">
                                        <option value="">Select Region First</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="club_container">
                                    <label for="id_club" class="form-label">Club</label>
                                    <select name="club" class="form-select" id="id_club">
                                        <option value="">Select LFA First</option>
                                    </select>
                                </div>
                                <div class="mb-3 d-none" id="association_container">
                                    {{ form.association|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Documents & Security -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingFour">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                                Step 4: Documents & Security
                            </button>
                        </h2>
                        <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#registrationAccordion">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    {{ form.profile_picture|as_crispy_field }}
                                </div>
                                <div class="mb-3">
                                    {{ form.id_document|as_crispy_field }}
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ form.password|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ form.password2|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    {{ form.popi_act_consent|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg" id="submit_btn">Register</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded and parsed.');

    // --- FIELD SELECTORS ---
    const roleField = document.getElementById('id_role');
    const isExistingMemberField = document.getElementById('id_is_existing_member');
    const previousSafaIdContainer = document.getElementById('previous_safa_id_container');
    const idDocumentTypeField = document.getElementById('id_id_document_type');
    const saIdContainer = document.getElementById('sa_id_container');
    const passportContainer = document.getElementById('passport_container');
    const manualDobGenderContainer = document.getElementById('manual_dob_gender_container');
    const clubContainer = document.getElementById('club_container');
    const associationContainer = document.getElementById('div_id_association');
    const idNumberField = document.getElementById('id_id_number');
    const dobField = document.getElementById('id_date_of_birth');
    const genderField = document.getElementById('id_gender');
    const provinceField = document.getElementById('id_province');
    const regionField = document.getElementById('id_region');
    const lfaField = document.getElementById('id_lfa');
    const clubField = document.getElementById('id_club');

    console.log('Fields selected:', { provinceField, regionField, lfaField, clubField });

    // --- UTILITY FUNCTIONS ---
    const showField = (el) => el.classList.remove('d-none');
    const hideField = (el) => el.classList.add('d-none');

    // --- EVENT HANDLERS ---

    // Handle Role Change
    if (roleField) {
        roleField.addEventListener('change', function() {
            console.log('Role field changed to:', this.value);
            if (this.value === 'PLAYER') {
                showField(clubContainer);
                hideField(associationContainer);
                if (clubField) clubField.required = true;
                const associationSelect = document.getElementById('id_association');
                if (associationSelect) associationSelect.required = false;
            } else if (this.value === 'OFFICIAL') {
                hideField(clubContainer);
                showField(associationContainer);
                if (clubField) clubField.required = false;
                const associationSelect = document.getElementById('id_association');
                if (associationSelect) associationSelect.required = true;
            } else if (this.value === 'SUPPORTER') {
                hideField(clubContainer);
                hideField(associationContainer);
                const locationContainer = document.getElementById('headingThree').parentNode;
                if (locationContainer) {
                    hideField(locationContainer);
                }
            } else {
                hideField(clubContainer);
                hideField(associationContainer);
                const locationContainer = document.getElementById('headingThree').parentNode;
                if (locationContainer) {
                    showField(locationContainer);
                }
            }
        });
    }

    // Handle Existing Member Checkbox
    if (isExistingMemberField) {
        isExistingMemberField.addEventListener('change', function() {
            console.log('isExistingMemberField changed, checked:', this.checked);
            if (this.checked) {
                showField(previousSafaIdContainer);
            } else {
                hideField(previousSafaIdContainer);
            }
        });
    }

    // Handle Document Type Change
    if (idDocumentTypeField) {
        idDocumentTypeField.addEventListener('change', function() {
            console.log('idDocumentTypeField changed to:', this.value);
            if (this.value === 'ID') {
                showField(saIdContainer);
                hideField(passportContainer);
                hideField(manualDobGenderContainer);
            } else if (this.value === 'PP') {
                hideField(saIdContainer);
                showField(passportContainer);
                showField(manualDobGenderContainer);
            }
        });
    }

    // Handle SA ID Number Extraction
    if (idNumberField) {
        idNumberField.addEventListener('blur', function() {
            const idNumber = this.value;
            console.log('ID Number field blurred, value:', idNumber);
            if (idNumber.length === 13 && /^\\d+$/.test(idNumber)) {
                console.log('Fetching ID data for:', idNumber);
                fetch(`/local-accounts/ajax/extract-id-data/?id_number=${idNumber}`)
                    .then(response => {
                        console.log('ID data fetch response status:', response.status);
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('ID data received:', data);
                        if (data.date_of_birth && data.gender) {
                            if (dobField) dobField.value = data.date_of_birth;
                            if (genderField) genderField.value = data.gender;
                            
                            idNumberField.classList.remove('is-invalid');
                            idNumberField.classList.add('is-valid');
                        } else if (data.error) {
                            idNumberField.classList.add('is-invalid');
                            console.error('ID Extraction Error:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching ID data:', error);
                        idNumberField.classList.add('is-invalid');
                    });
            } else if (idNumber.length > 0) {
                idNumberField.classList.add('is-invalid');
            }
        });
    }

    // --- CASCADING DROPDOWNS ---
    function updateDropdown(url, targetElement, prompt) {
        console.log('updateDropdown called for URL:', url, 'Target:', targetElement.id);
        if (!targetElement) {
            console.error('updateDropdown: targetElement is null or undefined');
            return;
        }
        
        targetElement.innerHTML = `<option value="">Loading...</option>`;
        targetElement.disabled = true;

        fetch(url)
            .then(response => {
                console.log('Fetch response for dropdown:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Data received for dropdown:', data);
                targetElement.innerHTML = `<option value="">${prompt}</option>`;
                data.forEach(item => {
                    targetElement.add(new Option(item.name, item.id));
                });
                targetElement.disabled = false;
            })
            .catch(error => {
                console.error('Error loading dropdown:', error);
                targetElement.innerHTML = `<option value="">Error loading options</option>`;
                targetElement.disabled = false;
            });
    }

    if (provinceField) {
        provinceField.addEventListener('change', function() {
            const provinceId = this.value;
            console.log('Province field changed, ID:', provinceId);
            if (provinceId && regionField) {
                updateDropdown(`/local-accounts/api/regions-for-province/${provinceId}/`, regionField, 'Select Region');
            } else if (regionField) {
                console.log('Province ID empty, resetting Region dropdown.');
                regionField.innerHTML = '<option value="">Select Province First</option>';
            }
            if (lfaField) {
                console.log('Resetting LFA dropdown.');
                lfaField.innerHTML = '<option value="">Select Region First</option>';
            }
            if (clubField) {
                console.log('Resetting Club dropdown.');
                clubField.innerHTML = '<option value="">Select LFA First</option>';
            }
        });
    }

    if (regionField) {
        regionField.addEventListener('change', function() {
            const regionId = this.value;
            console.log('Region field changed, ID:', regionId);
            if (regionId && lfaField) {
                updateDropdown(`/local-accounts/api/lfas-for-region/${regionId}/`, lfaField, 'Select LFA');
            } else if (lfaField) {
                console.log('Region ID empty, resetting LFA dropdown.');
                lfaField.innerHTML = '<option value="">Select Region First</option>';
            }
            if (clubField) {
                console.log('Resetting Club dropdown.');
                clubField.innerHTML = '<option value="">Select LFA First</option>';
            }
        });
    }

    if (lfaField) {
        lfaField.addEventListener('change', function() {
            const lfaId = this.value;
            console.log('LFA field changed, ID:', lfaId);
            if (lfaId && clubField) {
                updateDropdown(`/local-accounts/api/clubs-for-lfa/${lfaId}/`, clubField, 'Select Club');
            } else if (clubField) {
                console.log('LFA ID empty, resetting Club dropdown.');
                clubField.innerHTML = '<option value="">Select LFA First</option>';
            }
        });
    }

    // --- INITIALIZATION ---
    console.log('Dispatching initial change events...');
    if (roleField) roleField.dispatchEvent(new Event('change'));
    if (idDocumentTypeField) idDocumentTypeField.dispatchEvent(new Event('change'));
    if (isExistingMemberField) isExistingMemberField.dispatchEvent(new Event('change'));

    // Trigger initial load for province if a value is already selected (e.g., on form error re-render)
    if (provinceField && provinceField.value) {
        console.log('Initial province value detected, triggering change event.');
        provinceField.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}