{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}SAFA Member Registration{% endblock %}

{% block content %}
<!-- Modal CSS temporarily disabled -->
<!--
<style>
/* Ensure age verification modal stays visible */
#ageVerificationModal {
    z-index: 9999 !important;
}

#ageVerificationModal.show {
    display: block !important;
}

#ageVerificationModal .modal-dialog {
    z-index: 10000 !important;
}

/* Force modal visibility */
#ageVerificationModal.fade.show {
    display: block !important;
    opacity: 1 !important;
}

#ageVerificationModal .modal-backdrop {
    z-index: 9998 !important;
}

/* Prevent modal from being hidden */
#ageVerificationModal {
    pointer-events: auto !important;
}

#ageVerificationModal.show {
    visibility: visible !important;
    opacity: 1 !important;
}

/* Override any Bootstrap hiding */
.modal.fade.show {
    display: block !important;
    opacity: 1 !important;
}

/* Ensure backdrop stays visible */
.modal-backdrop.show {
    opacity: 0.5 !important;
    display: block !important;
}

/* Debug styles */
.modal-debug {
    border: 3px solid red !important;
    small>/* Ensure age verification modal stays visible */
#ageVerificationModal {
    z-index: 9999 !important;
}

#ageVerificationModal.show {
    display: block !important;
}

#ageVerificationModal .modal-dialog {
    z-index: 10000 !important;
}

/* Force modal visibility */
#ageVerificationModal.fade.show {
    display: block !important;
    opacity: 1 !important;
}

#ageVerificationModal .modal-backdrop {
    z-index: 9998 !important;
}

/* Prevent modal from being hidden */
#ageVerificationModal {
    pointer-events: auto !important;
}

#ageVerificationModal.show {
    visibility: visible !important;
    opacity: 1 !important;
}

/* Override any Bootstrap hiding */
.modal.fade.show {
    display: block !important;
    opacity: 1 !important;
}

/* Ensure backdrop stays visible */
.modal-backdrop.show {
    opacity: 0.5 !important;
    display: block !important;
}

/* Debug styles */
.modal-debug {
    border: 3px solid red !important;
    background-color: rgba(255, 0, 0, 0.2) !important;
}
</style>
-->

{% if not is_club_admin_registration %}
<!-- Debug: Public registration detected, age verification modal temporarily disabled -->
<!-- 
Age Verification Modal - TEMPORARILY DISABLED
<div class="modal fade" id="ageVerificationModal" tabindex="-1" aria-labelledby="ageVerificationModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="ageVerificationModalLabel">
                    <i class="fas fa-user-check me-2"></i>Age Verification Required
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-question-circle fa-3x text-primary mb-3"></i>
                    <h4>Are you 18 years or older?</h4>
                    <p class="text-muted">You must be 18 or older to register on SAFA Connect</p>
                </div>
                <div class="row">
                    <div class="col-6">
                        <button type="button" class="btn btn-success btn-lg w-100" id="yesOver18">
                            <i class="fas fa-check me-2"></i>Yes, I am 18+
                        </button>
                    </div>
                    <div class="div class="col-6">
                        <button type="button" class="btn btn-secondary btn-lg w-100" id="noUnder18">
                            <i class="fas fa-times me-2"></i>No, I am under 18
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

Thank You Modal for Under 18 - TEMPORARILY DISABLED
<div class="modal fade" id="thankYouModal" tabindex="-1" aria-labelledby="thankYouModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="thankYouModalLabel">
                    <i class="fas fa-heart me-2"></i>Thank You for Visiting SAFA Connect
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-info-circle fa-3x text-info mb-3"></i>
                    <h4>Registration Age Requirement</h4>
                    <p class="text-muted">You must be 18 years or older to register directly on this website.</p>
                    <p class="text-muted">If you are under 18 and would like to join SAFA, please contact your local club administrator who can assist you with registration.</p>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Note:</strong> Club administrators can register minors with proper parent/guardian consent through their admin interface.
                </div>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="fas fa-home me-2"></i>Return to Home
                </button>
            </div>
        </div>
    </div>
</div>
-->
{% else %}
<!-- Debug: Club admin registration detected, skipping age verification modal -->
{% endif %}

<div class="container my-5" id="registrationContainer" {% if is_club_admin_registration %}style="display: block;" data-is-club-admin="true"{% else %}style="display: block;" data-is-club-admin="false"{% endif %}>
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <h1 class="mb-4 text-center">SAFA Member Registration</h1>
            
            <!-- Age requirement notice -->
            <div class="alert alert-info text-center mb-4">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Age Requirement:</strong> You must be 18 years or older to register on SAFA Connect. 
                If you are under 18, please contact your local club administrator for registration assistance.
            </div>

            <form method="post" enctype="multipart/form-data" id="registrationForm" novalidate>
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        {% for error in form.non_field_errors %}
                            <p class="mb-0">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                {% if form.errors and not form.non_field_errors %}
                     <div class="alert alert-danger" role="alert">
                        <p class="mb-0">Please correct the errors highlighted below to continue.</p>
                        {% for field in form %}
                            {% for error in field.errors %}
                                <p class="mb-0"><strong>{{ field.label }}:</strong> {{ error }}</p>
                            {% endfor %}
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="accordion" id="registrationAccordion">

                    <!-- Step 1: Role and Basic Info -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                Step 1: Your Role & Basic Information
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#registrationAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ form.role|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6 mb-3 d-flex align-items-center pt-3">
                                        {{ form.is_existing_member|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="mb-3 d-none" id="previous_safa_id_container">
                                    {{ form.previous_safa_id|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Personal Details -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                Step 2: Personal Details
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#registrationAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ form.first_name|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ form.last_name|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        {{ form.has_email|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="mb-3" id="email_container">
                                    {{ form.email|as_crispy_field }}
                                    <div id="generated_email_notice" class="alert alert-info d-none mt-2">
                                        <i class="fas fa-info-circle"></i> An email address will be automatically generated for this member.
                                    </div>
                                </div>
                                <div class="mb-3">
                                    {{ form.id_document_type|as_crispy_field }}
                                </div>
                                <div class="mb-3 d-none" id="sa_id_container">
                                    {{ form.id_number|as_crispy_field }}
                                    <div id="id-validation-message" class="mt-1 small"></div>
                                </div>
                                <div class="mb-3 d-none" id="passport_container">
                                    {{ form.passport_number|as_crispy_field }}
                                </div>
                                <div class="row d-none" id="manual_dob_gender_container">
                                    <div class="col-md-6 mb-3">
                                        {{ form.date_of_birth|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ form.gender|as_crispy_field }}
                                    </div>
                                </div>
                                {{ form.extracted_dob }}
                                {{ form.extracted_gender }}
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Location -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingThree">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                Step 3: Your Location
                            </button>
                        </h2>
                        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#registrationAccordion">
                            <div class="accordion-body">
                                {% if form.province.field.disabled %}
                                    <div class="alert alert-info mb-3">
                                        <i class="fas fa-info-circle"></i> 
                                        The geographic fields below are pre-filled based on your club's location and cannot be changed.
                                    </div>
                                    <div class="mb-3">
                                        {{ form.province|as_crispy_field }}
                                    </div>
                                    <div class="mb-3">
                                        {{ form.region|as_crispy_field }}
                                    </div>
                                    <div class="mb-3">
                                        {{ form.lfa|as_crispy_field }}
                                    </div>
                                    <div class="mb-3" id="club_container">
                                        {{ form.club|as_crispy_field }}
                                    </div>
                                {% else %}
                                    <div class="mb-3">
                                        {{ form.province|as_crispy_field }}
                                    </div>
                                    <div class="mb-3">
                                        <label for="id_region" class="form-label">Region</label>
                                        <select name="region" class="form-select" id="id_region">
                                            <option value="">Select Province First</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="id_lfa" class="form-label">Local Football Association</label>
                                        <select name="lfa" class="form-select" id="id_lfa">
                                            <option value="">Select Region First</option>
                                        </select>
                                    </div>
                                    <div class="mb-3" id="club_container">
                                        <label for="id_club" class="form-label">Club</label>
                                        <select name="club" class="form-select" id="id_club">
                                            <option value="">Select LFA First</option>
                                        </select>
                                    </div>
                                {% endif %}
                                <div class="mb-3 d-none" id="association_container">
                                    {{ form.association|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Documents & Security -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingFour">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                                Step 4: Documents & Security
                            </button>
                        </h2>
                        <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#registrationAccordion">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    {{ form.profile_picture|as_crispy_field }}
                                </div>
                                <div class="mb-3">
                                    {{ form.id_document|as_crispy_field }}
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ form.password|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ form.password2|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    {{ form.popi_act_consent|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg" id="submit_btn">Register</button>
                </div>
            </form>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include the SA ID validation script -->
<script src="{% static 'js/sa_id_validation.js' %}"></script>
<!-- Include the registration validation script - TEMPORARILY DISABLED -->
<!-- <script src="{% static 'js/registration_validation.js' %}?v=1.1"></script> -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        console.log('DOM fully loaded and parsed.');

        // --- FIELD SELECTORS ---
    const roleField = document.getElementById('id_role');
    const isExistingMemberField = document.getElementById('id_is_existing_member');
    const previousSafaIdContainer = document.getElementById('previous_safa_id_container');
    const hasEmailField = document.getElementById('id_has_email');
    const emailField = document.getElementById('id_email');
    const emailContainer = document.getElementById('email_container');
    const generatedEmailNotice = document.getElementById('generated_email_notice');
    const idDocumentTypeField = document.getElementById('id_id_document_type');
    const saIdContainer = document.getElementById('sa_id_container');
    const passportContainer = document.getElementById('passport_container');
    const manualDobGenderContainer = document.getElementById('manual_dob_gender_container');
    const clubContainer = document.getElementById('club_container');
    const associationContainer = document.getElementById('association_container');
    const idNumberField = document.getElementById('id_id_number');
    const dobField = document.getElementById('id_date_of_birth');
    const genderField = document.getElementById('id_gender');
    const provinceField = document.getElementById('id_province');
    const regionField = document.getElementById('id_region');
    const lfaField = document.getElementById('id_lfa');
    const clubField = document.getElementById('id_club');

    console.log('Fields selected:', { 
        provinceField, 
        regionField, 
        lfaField, 
        clubField,
        idNumberField,
        dobField,
        genderField
    });
    
    // Store initial values of disabled fields to prevent changes
    const disabledFieldValues = {};
    [provinceField, regionField, lfaField, clubField].forEach(field => {
        if (field && field.disabled) {
            disabledFieldValues[field.id] = field.value;
            console.log('Storing initial value for disabled field:', field.id, '=', field.value);
        }
    });

    // --- UTILITY FUNCTIONS ---
    const showField = (el) => {
        try {
            if (el && el.classList) {
                el.classList.remove('d-none');
            } else {
                console.warn('showField: Invalid element provided:', el);
            }
        } catch (error) {
            console.error('Error in showField:', error);
        }
    };
    
    const hideField = (el) => {
        try {
            if (el && el.classList) {
                el.classList.add('d-none');
            } else {
                console.warn('hideField: Invalid element provided:', el);
            }
        } catch (error) {
            console.error('Error in hideField:', error);
        }
    };

    // --- EVENT HANDLERS ---

    // Handle Role Change
    if (roleField) {
        roleField.addEventListener('change', function() {
            try {
                console.log('Role field changed to:', this.value);
                const role = this.value;
                const associationSelect = document.getElementById('id_association');

                // Default state
                hideField(clubContainer);
                hideField(associationContainer);
                if (clubField) clubField.required = false;
                if (associationSelect) associationSelect.required = false;

                if (role === 'PLAYER') {
                    showField(clubContainer);
                    if (clubField) clubField.required = true;
                } else if (role === 'OFFICIAL') {
                    showField(clubContainer);
                    showField(associationContainer);
                    // Make association required for officials, club is optional
                    if (associationSelect) associationSelect.required = true;
                } else if (role === 'CLUB_ADMIN') {
                    showField(clubContainer);
                    if (clubField) clubField.required = true;
                } else if (role === 'ASSOCIATION_ADMIN') {
                    // Association Admin needs to select which association they will administer
                    showField(associationContainer);
                    if (associationSelect) associationSelect.required = true;
                } else if (role === 'SUPPORTER') {
                    const locationContainer = document.getElementById('headingThree').parentNode;
                    if (locationContainer) {
                        hideField(locationContainer);
                    }
                } else {
                    // For other roles like LFA, Region, Province admins, show location but not necessarily club/association
                    const locationContainer = document.getElementById('headingThree').parentNode;
                    if (locationContainer) {
                        showField(locationContainer);
                    }
                }
            } catch (error) {
                console.error('Error in role change handler:', error);
            }
        });
    }

    // Handle Existing Member Checkbox
    if (isExistingMemberField) {
        isExistingMemberField.addEventListener('change', function() {
            try {
                console.log('isExistingMemberField changed, checked:', this.checked);
                if (this.checked) {
                    showField(previousSafaIdContainer);
                } else {
                    hideField(previousSafaIdContainer);
                }
            } catch (error) {
                console.error('Error in existing member checkbox handler:', error);
            }
        });
    }

    // Handle Has Email Checkbox
    if (hasEmailField) {
        hasEmailField.addEventListener('change', function() {
            try {
                console.log('hasEmailField changed, checked:', this.checked);
                if (this.checked) {
                    // User has email - show email field and hide notice
                    if (emailField) {
                        emailField.style.opacity = '1';
                        emailField.disabled = false;
                        emailField.required = true;
                        emailField.parentElement.style.pointerEvents = 'auto';
                    }
                    hideField(generatedEmailNotice);
                } else {
                    // User doesn't have email - grey out email field and show notice
                    if (emailField) {
                        emailField.style.opacity = '0.5';
                        emailField.disabled = true;
                        emailField.required = false;
                        emailField.value = ''; // Clear any entered value
                        emailField.parentElement.style.pointerEvents = 'none';
                    }
                    showField(generatedEmailNotice);
                }
            } catch (error) {
                console.error('Error in has email checkbox handler:', error);
            }
        });

        // Trigger initial state
        hasEmailField.dispatchEvent(new Event('change'));
    }

    // Handle Document Type Change
    if (idDocumentTypeField) {
        idDocumentTypeField.addEventListener('change', function() {
            try {
                console.log('idDocumentTypeField changed to:', this.value);
                
                // Get all relevant fields
                const idNumberField = document.getElementById('id_id_number');
                const passportNumberField = document.getElementById('id_passport_number');
                const dobField = document.getElementById('id_date_of_birth');
                const genderField = document.getElementById('id_gender');
                const idValidationMessage = document.getElementById('id-validation-message');
                
                // Validate that required containers exist
                if (!saIdContainer || !passportContainer || !manualDobGenderContainer) {
                    console.error('Required containers not found:', { saIdContainer, passportContainer, manualDobGenderContainer });
                    return;
                }
                
                if (this.value === 'ID') {
                    // Clear passport number when switching to ID
                    if (passportNumberField) passportNumberField.value = '';
                    
                    showField(saIdContainer);
                    hideField(passportContainer);
                    hideField(manualDobGenderContainer);
                    
                    // Clear any validation messages
                    if (idValidationMessage) {
                        idValidationMessage.textContent = '';
                        idValidationMessage.classList.remove('text-success', 'text-danger');
                    }
                    
                    // Set up ID validation when ID field becomes visible
                    console.log('About to set up ID validation...');
                    setTimeout(() => {
                        try {
                            console.log('Setting up ID validation for visible field');
                            setupIDValidation();
                        } catch (error) {
                            console.error('Error setting up ID validation:', error);
                        }
                    }, 100);
                    
                } else if (this.value === 'PP') {
                    // Clear ID number when switching to passport
                    if (idNumberField) {
                        idNumberField.value = '';
                        idNumberField.classList.remove('is-valid', 'is-invalid');
                    }
                    
                    // Clear validation message
                    if (idValidationMessage) {
                        idValidationMessage.textContent = '';
                        idValidationMessage.classList.remove('text-success', 'text-danger');
                    }
                    
                    hideField(saIdContainer);
                    showField(passportContainer);
                    showField(manualDobGenderContainer);
                    
                    // Clear and enable DOB and gender fields for manual entry
                    if (dobField) {
                        dobField.value = '';
                        dobField.readOnly = false;
                        dobField.disabled = false;
                        dobField.style.backgroundColor = '';
                        dobField.style.cursor = '';
                        dobField.title = '';
                    }
                    if (genderField) {
                        genderField.value = '';
                        genderField.disabled = false;
                        genderField.style.backgroundColor = '';
                        genderField.style.cursor = '';
                        genderField.title = '';
                    }
                }
            } catch (error) {
                console.error('Error in document type change handler:', error);
            }
        });
    }
    
    // Simple ID validation setup (same as working admin_add_referee)
    function setupIDValidation() {
        try {
            console.log('setupIDValidation function called');
            const idNumberField = document.getElementById('id_id_number');
            const idValidationMessage = document.getElementById('id-validation-message');
            const dobField = document.getElementById('id_date_of_birth');
            const genderField = document.getElementById('id_gender');
            const manualDobGenderContainer = document.getElementById('manual_dob_gender_container');
            
            // Validate that required elements exist
            if (!idNumberField || !idValidationMessage || !dobField || !genderField || !manualDobGenderContainer) {
                console.error('Required validation elements not found:', {
                    idNumberField: !!idNumberField,
                    idValidationMessage: !!idValidationMessage,
                    dobField: !!dobField,
                    genderField: !!genderField,
                    manualDobGenderContainer: !!manualDobGenderContainer
                });
                return;
            }
            
            console.log('ID validation elements found:', {
                idNumberField: idNumberField,
                idValidationMessage: idValidationMessage,
                dobField: dobField,
                genderField: genderField,
                manualDobGenderContainer: manualDobGenderContainer
            });

            function validateIDNumber() {
                try {
                    console.log('validateIDNumber function called');
                    const idNumber = idNumberField.value;
                    console.log('ID Number value:', idNumber);
                    
                    if (typeof validateSAIDNumber !== 'function') {
                        console.error('validateSAIDNumber function not found!');
                        return;
                    }
                    
                    const validationResult = validateSAIDNumber(idNumber);
                    console.log('Validation result:', validationResult);

                    if (validationResult.isValid) {
                // Show success message
                idValidationMessage.textContent = '';
                idValidationMessage.classList.remove('text-danger');
                idValidationMessage.classList.add('text-success');
                idValidationMessage.textContent = `Valid ID. DOB: ${formatDateYMD(validationResult.dateOfBirth)}, Gender: ${validationResult.gender}, Citizenship: ${validationResult.citizenship}`;
                
                // Set the DOB and gender fields
                if (dobField) dobField.value = formatDateYMD(validationResult.dateOfBirth);
                if (genderField) genderField.value = validationResult.gender;
                
                                 // Show the DOB and gender fields container but make them read-only
                 if (manualDobGenderContainer) {
                     manualDobGenderContainer.classList.remove('d-none');
                     // Make the fields read-only to prevent manual editing
                     if (dobField) {
                         dobField.readOnly = true;
                         dobField.style.backgroundColor = '#f8f9fa';
                         dobField.style.cursor = 'not-allowed';
                         // Add a visual indicator that it's auto-filled
                         dobField.title = 'This field is auto-filled from your ID number and cannot be changed';
                     }
                     if (genderField) {
                         genderField.disabled = true;
                         genderField.style.backgroundColor = '#f8f9fa';
                         genderField.style.cursor = 'not-allowed';
                         // Add a visual indicator that it's auto-filled
                         genderField.title = 'This field is auto-filled from your ID number and cannot be changed';
                     }
                 }
                
                // Update field styling
                idNumberField.classList.remove('is-invalid');
                idNumberField.classList.add('is-valid');
            } else {
                // Show error message
                idValidationMessage.textContent = '';
                idValidationMessage.classList.remove('text-success');
                idValidationMessage.classList.add('text-danger');
                idValidationMessage.textContent = validationResult.errorMessage;
                
                // Clear the DOB and gender fields
                if (dobField) dobField.value = '';
                if (genderField) genderField.value = '';
                
                                 // Hide the DOB and gender fields container and re-enable them
                 if (manualDobGenderContainer) {
                     manualDobGenderContainer.classList.add('d-none');
                     // Re-enable the fields for manual entry if ID is invalid
                     if (dobField) {
                         dobField.readOnly = false;
                         dobField.style.backgroundColor = '';
                         dobField.style.cursor = '';
                         dobField.title = '';
                     }
                     if (genderField) {
                         genderField.disabled = false;
                         genderField.style.backgroundColor = '';
                         genderField.style.cursor = '';
                         genderField.title = '';
                     }
                 }
                
                // Update field styling
                idNumberField.classList.remove('is-valid');
                idNumberField.classList.add('is-invalid');
            }
                } catch (error) {
                    console.error('Error in validateIDNumber:', error);
                    // Show generic error message
                    if (idValidationMessage) {
                        idValidationMessage.textContent = 'Error validating ID number. Please try again.';
                        idValidationMessage.classList.remove('text-success');
                        idValidationMessage.classList.add('text-danger');
                    }
                }
            }

            // Add event listener for ID number field
            if (idNumberField) {
                idNumberField.addEventListener('input', validateIDNumber);
            }
        } catch (error) {
            console.error('Error in setupIDValidation:', error);
        }
    }

    // Handle SA ID Number Extraction - Now handled dynamically when ID field becomes visible

    // --- CASCADING DROPDOWNS ---
    function updateDropdown(url, targetElement, prompt) {
        console.log('updateDropdown called for URL:', url, 'Target:', targetElement.id);
        if (!targetElement) {
            console.error('updateDropdown: targetElement is null or undefined');
            return;
        }
        
        // Check if the target element is disabled - if so, don't allow updates
        if (targetElement.disabled) {
            console.log('Target element is disabled, skipping update:', targetElement.id);
            return;
        }
        
        targetElement.innerHTML = `<option value="">Loading...</option>`;
        targetElement.disabled = true;

        fetch(url)
            .then(response => {
                console.log('Fetch response for dropdown:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Data received for dropdown:', data);
                targetElement.innerHTML = `<option value="">${prompt}</option>`;
                data.forEach(item => {
                    targetElement.add(new Option(item.name, item.id));
                });
                targetElement.disabled = false;
            })
            .catch(error => {
                console.error('Error loading dropdown:', error);
                targetElement.innerHTML = `<option value="">Error loading options</option>`;
                targetElement.disabled = false;
            });
    }

    if (provinceField) {
        // Only add event listener if the field is not disabled
        if (!provinceField.disabled) {
            provinceField.addEventListener('change', function() {
                try {
                    const provinceId = this.value;
                    console.log('Province field changed, ID:', provinceId);
                    if (provinceId && regionField && !regionField.disabled) {
                        updateDropdown(`/local-accounts/api/regions-for-province/${provinceId}/`, regionField, 'Select Region');
                    } else if (regionField && !regionField.disabled) {
                        console.log('Province ID empty, resetting Region dropdown.');
                        regionField.innerHTML = '<option value="">Select Province First</option>';
                    }
                    if (lfaField && !lfaField.disabled) {
                        console.log('Resetting LFA dropdown.');
                        lfaField.innerHTML = '<option value="">Select Region First</option>';
                    }
                    if (clubField && !clubField.disabled) {
                        console.log('Resetting Club dropdown.');
                        clubField.innerHTML = '<option value="">Select LFA First</option>';
                    }
                } catch (error) {
                    console.error('Error in province change handler:', error);
                }
            });
        } else {
            console.log('Province field is disabled, skipping event listener');
        }
    }

    if (regionField) {
        // Only add event listener if the field is not disabled
        if (!regionField.disabled) {
            regionField.addEventListener('change', function() {
                try {
                    const regionId = this.value;
                    console.log('Region field changed, ID:', regionId);
                    if (regionId && lfaField && !lfaField.disabled) {
                        updateDropdown(`/local-accounts/api/lfas-for-region/${regionId}/`, lfaField, 'Select LFA');
                    } else if (lfaField && !lfaField.disabled) {
                        console.log('Region ID empty, resetting LFA dropdown.');
                        lfaField.innerHTML = '<option value="">Select Region First</option>';
                    }
                    if (clubField && !clubField.disabled) {
                        console.log('Resetting Club dropdown.');
                        clubField.innerHTML = '<option value="">Select LFA First</option>';
                    }
                } catch (error) {
                    console.error('Error in region change handler:', error);
                }
            });
        } else {
            console.log('Region field is disabled, skipping event listener');
        }
    }

    if (lfaField) {
        // Only add event listener if the field is not disabled
        if (!lfaField.disabled) {
            lfaField.addEventListener('change', function() {
                try {
                    const lfaId = this.value;
                    console.log('LFA field changed, ID:', lfaId);
                    if (lfaId && clubField && !clubField.disabled) {
                        updateDropdown(`/local-accounts/api/clubs-for-lfa/${lfaId}/`, clubField, 'Select Club');
                    } else if (clubField && !clubField.disabled) {
                        console.log('LFA ID empty, resetting Club dropdown.');
                        clubField.innerHTML = '<option value="">Select LFA First</option>';
                    }
                } catch (error) {
                    console.error('Error in LFA change handler:', error);
                }
            });
        } else {
            console.log('LFA field is disabled, skipping event listener');
        }
    }

    // --- INITIALIZATION ---
    try {
        console.log('Dispatching initial change events...');
        if (roleField) roleField.dispatchEvent(new Event('change'));
        if (idDocumentTypeField) idDocumentTypeField.dispatchEvent(new Event('change'));
        if (isExistingMemberField) isExistingMemberField.dispatchEvent(new Event('change'));

        // Trigger initial load for province if a value is already selected (e.g., on form error re-render)
        if (provinceField && provinceField.value && !provinceField.disabled) {
            console.log('Initial province value detected, triggering change event.');
            provinceField.dispatchEvent(new Event('change'));
        }
        
            // Add protection against programmatic changes to disabled fields
    const disabledFields = [provinceField, regionField, lfaField, clubField].filter(field => field && field.disabled);
    disabledFields.forEach(field => {
        console.log('Adding protection to disabled field:', field.id);
        
        // Store the original value
        const originalValue = field.value;
        
        // Prevent any value changes to disabled fields
        field.addEventListener('change', function(e) {
            if (this.disabled) {
                console.log('Preventing change to disabled field:', this.id);
                // Restore the original value
                this.value = originalValue;
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        });
        
        // Prevent any input to disabled fields
        field.addEventListener('input', function(e) {
            if (this.disabled) {
                console.log('Preventing input to disabled field:', this.id);
                // Restore the original value
                this.value = originalValue;
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        });
        
        // Also prevent any programmatic value changes
        Object.defineProperty(field, 'value', {
            set: function(newValue) {
                if (this.disabled) {
                    console.log('Preventing programmatic value change to disabled field:', this.id);
                    return; // Don't allow the value to be changed
                }
                // Use the original setter if not disabled
                Object.getOwnPropertyDescriptor(HTMLSelectElement.prototype, 'value').set.call(this, newValue);
            },
            get: function() {
                return Object.getOwnPropertyDescriptor(HTMLSelectElement.prototype, 'value').get.call(this);
            }
        });
    });
        
    } catch (error) {
        console.error('Error during initialization:', error);
    }

    // --- POPI ACT CONSENT ---
    const popiConsentField = document.getElementById('id_popi_act_consent');
    const submitButton = document.getElementById('submit_btn');

    if (popiConsentField && submitButton) {
        // Disable the button initially
        submitButton.disabled = true;

        // Add event listener to the checkbox
        popiConsentField.addEventListener('change', function() {
            try {
                submitButton.disabled = !this.checked;
            } catch (error) {
                console.error('Error in POPI consent handler:', error);
            }
        });
    }
    
    // --- FORM SUBMISSION PROTECTION ---
    const registrationForm = document.getElementById('registrationForm');
    if (registrationForm) {
        registrationForm.addEventListener('submit', function(e) {
            try {
                // Ensure disabled fields maintain their original values
                Object.keys(disabledFieldValues).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && field.disabled) {
                        const originalValue = disabledFieldValues[fieldId];
                        if (field.value !== originalValue) {
                            console.log('Restoring original value for disabled field:', fieldId, 'from', field.value, 'to', originalValue);
                            field.value = originalValue;
                        }
                    }
                });
            } catch (error) {
                console.error('Error in form submission protection:', error);
            }
        });
    }
    
    // --- PERIODIC PROTECTION CHECK ---
    // Set up a periodic check to ensure disabled fields maintain their values
    setInterval(function() {
        try {
            Object.keys(disabledFieldValues).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.disabled) {
                    const originalValue = disabledFieldValues[fieldId];
                    if (field.value !== originalValue) {
                        console.log('Periodic check: Restoring original value for disabled field:', fieldId, 'from', field.value, 'to', originalValue);
                        field.value = originalValue;
                    }
                }
            });
        } catch (error) {
            console.error('Error in periodic protection check:', error);
        }
    }, 1000); // Check every second
        } catch (error) {
            console.error('Error in main registration script:', error);
        }
    });
</script>


{% endblock %}