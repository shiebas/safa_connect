<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAFA Member Approval Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-badge {
            font-size: 0.75rem;
            font-weight: 600;
        }
        .member-card {
            transition: all 0.3s ease;
            border-left: 4px solid #e9ecef;
        }
        .member-card:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .member-card.pending {
            border-left-color: #ffc107;
        }
        .member-card.approved {
            border-left-color: #198754;
        }
        .member-card.rejected {
            border-left-color: #dc3545;
        }
        .document-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }
        .member-type-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        .member-type-icon.player {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        .member-type-icon.official {
            background: linear-gradient(135deg, #007bff, #6610f2);
        }
        .member-type-icon.member {
            background: linear-gradient(135deg, #6c757d, #495057);
        }
        .invoice-status {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .invoice-status.paid {
            background: #d4edda;
            color: #155724;
        }
        .invoice-status.unpaid {
            background: #f8d7da;
            color: #721c24;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }
        .quick-actions {
            position: sticky;
            top: 20px;
        }
        .bulk-actions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        .bulk-actions.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-users me-3"></i>Member Approval Dashboard</h2>
                        <p class="text-muted">Review and approve member registrations</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sidebar with Stats and Filters -->
            <div class="col-lg-3">
                <div class="quick-actions">
                    <!-- Statistics Cards -->
                    <div class="stats-card p-4 mb-4">
                        <h5 class="mb-3">Registration Stats</h5>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="h4 mb-1">{{ players_count }}</div>
                                <small>Players</small>
                            </div>
                            <div class="col-4">
                                <div class="h4 mb-1">{{ officials_count }}</div>
                                <small>Officials</small>
                            </div>
                            <div class="col-4">
                                <div class="h4 mb-1">{{ general_members_count }}</div>
                                <small>Members</small>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filters</h6>
                        </div>
                        <div class="card-body">
                            <form method="get" id="filterForm">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" name="status" onchange="applyFilters()">
                                        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                                        <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approved</option>
                                        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Member Type</label>
                                    <select class="form-select" name="member_type" onchange="applyFilters()">
                                        <option value="">All Types</option>
                                        <option value="PLAYER">Players</option>
                                        <option value="OFFICIAL">Officials</option>
                                        <option value="MEMBER">General Members</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Payment Status</label>
                                    <select class="form-select" name="payment_status" onchange="applyFilters()">
                                        <option value="">All</option>
                                        <option value="paid">Paid</option>
                                        <option value="unpaid">Unpaid</option>
                                    </select>
                                </div>
                                
                                <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()">
                                    Clear Filters
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-success btn-sm w-100 mb-2" onclick="toggleBulkActions()">
                                <i class="fas fa-check-double me-2"></i>Bulk Actions
                            </button>
                            <button class="btn btn-warning btn-sm w-100 mb-2" onclick="sendPaymentReminders()">
                                <i class="fas fa-envelope me-2"></i>Payment Reminders
                            </button>
                            <button class="btn btn-info btn-sm w-100" onclick="generateReport()">
                                <i class="fas fa-chart-bar me-2"></i>Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Bulk Actions Panel -->
                <div class="bulk-actions" id="bulkActionsPanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Bulk Actions</h6>
                        <button class="btn-close" onclick="toggleBulkActions()"></button>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <select class="form-select" id="bulkAction">
                                <option value="">Select Action</option>
                                <option value="approve">Approve Selected</option>
                                <option value="reject">Reject Selected</option>
                                <option value="send_reminder">Send Payment Reminder</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary" onclick="executeBulkAction()">
                                Execute Action
                            </button>
                        </div>
                        <div class="col-md-2">
                            <span class="badge bg-secondary" id="selectedCount">0 selected</span>
                        </div>
                    </div>
                </div>

                <!-- Search and Sort -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" placeholder="Search members..." 
                                           id="searchInput" onkeyup="searchMembers()">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" onchange="sortMembers(this.value)">
                                    <option value="name">Sort by Name</option>
                                    <option value="date">Sort by Date</option>
                                    <option value="status">Sort by Status</option>
                                    <option value="type">Sort by Type</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="viewMode" id="cardView" 
                                           autocomplete="off" checked onchange="switchView('card')">
                                    <label class="btn btn-outline-primary" for="cardView">
                                        <i class="fas fa-th-large"></i>
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="viewMode" id="listView" 
                                           autocomplete="off" onchange="switchView('list')">
                                    <label class="btn btn-outline-primary" for="listView">
                                        <i class="fas fa-list"></i>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Members List -->
                <div id="membersContainer">
                    {% for member_data in members_data %}
                    <div class="member-card card mb-3 {{ member_data.member.status|lower }}" data-member-id="{{ member_data.member.id }}">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <!-- Bulk selection checkbox -->
                                <div class="col-auto">
                                    <input type="checkbox" class="form-check-input member-checkbox" 
                                           value="{{ member_data.member.id }}" onchange="updateSelectedCount()">
                                </div>
                                
                                <!-- Member Type Icon -->
                                <div class="col-auto">
                                    <div class="member-type-icon {{ member_data.member_type|lower }}">
                                        {% if member_data.member_type == 'Player' %}
                                            <i class="fas fa-futbol"></i>
                                        {% elif member_data.member_type == 'Official' %}
                                            <i class="fas fa-whistle"></i>
                                        {% else %}
                                            <i class="fas fa-user"></i>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Profile Picture -->
                                <div class="col-auto">
                                    {% if member_data.member.profile_picture %}
                                        <img src="{{ member_data.member.profile_picture.url }}" 
                                             class="document-thumbnail" alt="Profile"
                                             onclick="viewDocument('{{ member_data.member.profile_picture.url }}', 'Profile Picture')">
                                    {% else %}
                                        <div class="document-thumbnail bg-light d-flex align-items-center justify-content-center">
                                            <i class="fas fa-user text-muted"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Member Information -->
                                <div class="col">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">
                                                {{ member_data.member.get_full_name }}
                                                <span class="badge status-badge ms-2 
                                                    {% if member_data.member.status == 'ACTIVE' %}bg-success
                                                    {% elif member_data.member.status == 'PENDING' %}bg-warning
                                                    {% else %}bg-secondary{% endif %}">
                                                    {{ member_data.member.get_status_display }}
                                                </span>
                                            </h6>
                                            <p class="text-muted mb-1">
                                                <i class="fas fa-envelope me-1"></i>{{ member_data.member.email }}
                                                {% if member_data.member.safa_id %}
                                                    | <i class="fas fa-id-card me-1"></i>SAFA ID: {{ member_data.member.safa_id }}
                                                {% endif %}
                                            </p>
                                            <p class="text-muted mb-2">
                                                <i class="fas fa-calendar me-1"></i>{{ member_data.member.created|date:"M d, Y" }}
                                                {% if member_data.member.club %}
                                                    | <i class="fas fa-shield-alt me-1"></i>{{ member_data.member.club.name }}
                                                {% endif %}
                                            </p>
                                            
                                            <!-- Payment Status -->
                                            <div class="mb-2">
                                                {% if member_data.has_unpaid %}
                                                    <span class="invoice-status unpaid">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                                        {{ member_data.unpaid_invoices|length }} Unpaid Invoice{{ member_data.unpaid_invoices|length|pluralize }}
                                                    </span>
                                                {% else %}
                                                    <span class="invoice-status paid">
                                                        <i class="fas fa-check me-1"></i>All Payments Current
                                                    </span>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Missing Documents -->
                                            {% if member_data.missing_documents %}
                                                <div class="mb-2">
                                                    <small class="text-danger">
                                                        <i class="fas fa-file-times me-1"></i>
                                                        Missing: {{ member_data.missing_documents|join:", " }}
                                                    </small>
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Action Buttons -->
                                        <div class="btn-group-vertical">
                                            {% if member_data.member.status == 'PENDING' %}
                                                {% if not member_data.has_unpaid and not member_data.missing_documents %}
                                                    <button class="btn btn-success btn-sm mb-1" 
                                                            onclick="approveMember({{ member_data.member.id }})">
                                                        <i class="fas fa-check me-1"></i>Approve
                                                    </button>
                                                {% else %}
                                                    <button class="btn btn-success btn-sm mb-1" disabled 
                                                            title="Cannot approve: {% if member_data.has_unpaid %}Unpaid invoices{% endif %}{% if member_data.missing_documents %} Missing documents{% endif %}">
                                                        <i class="fas fa-check me-1"></i>Approve
                                                    </button>
                                                {% endif %}
                                                <button class="btn btn-danger btn-sm mb-1" 
                                                        onclick="rejectMember({{ member_data.member.id }})">
                                                    <i class="fas fa-times me-1"></i>Reject
                                                </button>
                                            {% endif %}
                                            
                                            <button class="btn btn-outline-primary btn-sm mb-1" 
                                                    onclick="viewMemberDetails({{ member_data.member.id }})">
                                                <i class="fas fa-eye me-1"></i>View
                                            </button>
                                            
                                            {% if member_data.has_unpaid %}
                                                <button class="btn btn-outline-warning btn-sm mb-1" 
                                                        onclick="sendPaymentReminder({{ member_data.member.id }})">
                                                    <i class="fas fa-envelope me-1"></i>Remind
                                                </button>
                                            {% endif %}
                                            
                                            <div class="dropdown">
                                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                                                        type="button" data-bs-toggle="dropdown">
                                                    <i class="fas fa-ellipsis-h"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="editMember({{ member_data.member.id }})">
                                                        <i class="fas fa-edit me-2"></i>Edit Details
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="viewDocuments({{ member_data.member.id }})">
                                                        <i class="fas fa-file-alt me-2"></i>View Documents
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="viewInvoices({{ member_data.member.id }})">
                                                        <i class="fas fa-receipt me-2"></i>View Invoices
                                                    </a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteMember({{ member_data.member.id }})">
                                                        <i class="fas fa-trash me-2"></i>Delete
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No members found</h5>
                        <p class="text-muted">Try adjusting your filters or search criteria.</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                <nav aria-label="Members pagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="changePage(1)">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="changePage('prev')">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                        <li class="page-item active">
                            <span class="page-link">1</span>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="changePage(2)">2</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="changePage(3)">3</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="changePage('next')">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="changePage('last')">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Modal for Member Details -->
    <div class="modal fade" id="memberDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Member Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="memberDetailsContent">
                    <!-- Will be loaded via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Document Viewer -->
    <div class="modal fade" id="documentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentModalTitle">Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="documentImage" class="img-fluid" style="max-height: 500px;">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Rejection Reason -->
    <div class="modal fade" id="rejectionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reject Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="rejectionForm">
                        <input type="hidden" id="rejectMemberId">
                        <div class="mb-3">
                            <label for="rejectionReason" class="form-label">Reason for Rejection</label>
                            <textarea class="form-control" id="rejectionReason" rows="4" required 
                                      placeholder="Please provide a clear reason for rejecting this member..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmRejection()">
                        <i class="fas fa-times me-2"></i>Reject Member
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let selectedMembers = new Set();
        let currentView = 'card';

        // Filter and search functions
        function applyFilters() {
            const form = document.getElementById('filterForm');
            const formData = new FormData(form);
            const params = new URLSearchParams(formData);
            window.location.href = `${window.location.pathname}?${params.toString()}`;
        }

        function clearFilters() {
            window.location.href = window.location.pathname;
        }

        function searchMembers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const memberCards = document.querySelectorAll('.member-card');
            
            memberCards.forEach(card => {
                const memberName = card.querySelector('h6').textContent.toLowerCase();
                const memberEmail = card.querySelector('.text-muted').textContent.toLowerCase();
                
                if (memberName.includes(searchTerm) || memberEmail.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function sortMembers(criteria) {
            const container = document.getElementById('membersContainer');
            const cards = Array.from(container.querySelectorAll('.member-card'));
            
            cards.sort((a, b) => {
                let aValue, bValue;
                
                switch(criteria) {
                    case 'name':
                        aValue = a.querySelector('h6').textContent.trim();
                        bValue = b.querySelector('h6').textContent.trim();
                        break;
                    case 'date':
                        aValue = a.querySelector('.fas.fa-calendar').parentNode.textContent;
                        bValue = b.querySelector('.fas.fa-calendar').parentNode.textContent;
                        break;
                    case 'status':
                        aValue = a.querySelector('.status-badge').textContent;
                        bValue = b.querySelector('.status-badge').textContent;
                        break;
                    case 'type':
                        aValue = a.querySelector('.member-type-icon').className;
                        bValue = b.querySelector('.member-type-icon').className;
                        break;
                }
                
                return aValue.localeCompare(bValue);
            });
            
            cards.forEach(card => container.appendChild(card));
        }

        // View switching
        function switchView(view) {
            currentView = view;
            const memberCards = document.querySelectorAll('.member-card');
            
            if (view === 'list') {
                memberCards.forEach(card => {
                    card.classList.add('list-view');
                    // Additional styling for list view could be added here
                });
            } else {
                memberCards.forEach(card => {
                    card.classList.remove('list-view');
                });
            }
        }

        // Bulk actions
        function toggleBulkActions() {
            const panel = document.getElementById('bulkActionsPanel');
            panel.classList.toggle('show');
            
            // Reset selections when closing
            if (!panel.classList.contains('show')) {
                selectedMembers.clear();
                document.querySelectorAll('.member-checkbox').forEach(cb => cb.checked = false);
                updateSelectedCount();
            }
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.member-checkbox:checked');
            selectedMembers.clear();
            
            checkboxes.forEach(cb => {
                selectedMembers.add(parseInt(cb.value));
            });
            
            document.getElementById('selectedCount').textContent = `${selectedMembers.size} selected`;
        }

        function executeBulkAction() {
            const action = document.getElementById('bulkAction').value;
            if (!action || selectedMembers.size === 0) {
                alert('Please select an action and at least one member.');
                return;
            }
            
            if (confirm(`Are you sure you want to ${action} ${selectedMembers.size} member(s)?`)) {
                // Send AJAX request for bulk action
                fetch('/registration/bulk-action/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        action: action,
                        member_ids: Array.from(selectedMembers)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Bulk action completed successfully!', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showNotification('Error: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showNotification('Network error occurred.', 'error');
                });
            }
        }

        // Individual member actions
        function approveMember(memberId) {
            if (confirm('Are you sure you want to approve this member?')) {
                fetch(`/registration/approve-member/${memberId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Member approved successfully!', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showNotification('Error: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showNotification('Network error occurred.', 'error');
                });
            }
        }

        function rejectMember(memberId) {
            document.getElementById('rejectMemberId').value = memberId;
            const modal = new bootstrap.Modal(document.getElementById('rejectionModal'));
            modal.show();
        }

        function confirmRejection() {
            const memberId = document.getElementById('rejectMemberId').value;
            const reason = document.getElementById('rejectionReason').value;
            
            if (!reason.trim()) {
                alert('Please provide a reason for rejection.');
                return;
            }
            
            fetch(`/registration/reject-member/${memberId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    reason: reason
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Member rejected successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('rejectionModal')).hide();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showNotification('Network error occurred.', 'error');
            });
        }

        function viewMemberDetails(memberId) {
            fetch(`/registration/member-details/${memberId}/`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('memberDetailsContent').innerHTML = html;
                    const modal = new bootstrap.Modal(document.getElementById('memberDetailsModal'));
                    modal.show();
                })
                .catch(error => {
                    showNotification('Error loading member details.', 'error');
                });
        }

        function viewDocument(url, title) {
            document.getElementById('documentModalTitle').textContent = title;
            document.getElementById('documentImage').src = url;
            const modal = new bootstrap.Modal(document.getElementById('documentModal'));
            modal.show();
        }

        function sendPaymentReminder(memberId) {
            fetch(`/registration/send-payment-reminder/${memberId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Payment reminder sent successfully!', 'success');
                } else {
                    showNotification('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showNotification('Network error occurred.', 'error');
            });
        }

        // Utility functions
        function showNotification(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        function refreshDashboard() {
            location.reload();
        }

        function exportData() {
            window.open('/registration/export-members/', '_blank');
        }

        function generateReport() {
            window.open('/registration/generate-report/', '_blank');
        }

        // Pagination
        function changePage(page) {
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('page', page);
            window.location.href = currentUrl.toString();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Add CSRF token to all forms if not present
            if (!document.querySelector('[name=csrfmiddlewaretoken]')) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = '{{ csrf_token }}';
                document.body.appendChild(csrfInput);
            }
        });
    </script>
</body>
</html>